<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Preço Certo — Calculadora de Markup (Revisada)</title>
<style>
  /* Estilos originais mantidos e aprimorados para clareza */
  *, *::before, *::after { box-sizing: border-box; }
  :root{
    --bg1:#111827; --bg2:#0b1220; --card:#0f172a; --border:#1f2937;
    --text:#e5e7eb; --muted:#a1a1aa;
    --brand1:#6366f1; --brand2:#8b5cf6; --success:#22c55e; --danger:#ef4444;
    --radius:14px; --shadow:0 10px 24px rgba(0,0,0,.35);
  }
  html,body{ margin:0; background:linear-gradient(160deg,#1e293b,#0f172a); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial; }
  .container{ max-width:760px; margin:0 auto; padding:10px 12px 24px; }

  /* Título */
  .app-title{ text-align:center; font-size:28px; font-weight:900; text-transform:uppercase; letter-spacing:1px; color:#ffffff; margin:10px 0 6px; }
  .app-sub{ text-align:center; font-size:13px; color:#94a3b8; margin:0 0 10px; }

  /* Hero */
  .hero{ background:linear-gradient(135deg,#3b82f6,#8b5cf6); border-radius:16px; box-shadow:var(--shadow); padding:14px; text-align:center; }
  .hero .title{ font-size:12px; opacity:.9; margin-bottom:2px; }
  .hero .price{ font-size:28px; font-weight:900; margin:0; line-height:1; }
  .hero .sub{ font-size:11px; opacity:.85; margin-top:4px; }
  .hero .alt{ margin-top:6px; font-size:14px; font-weight:700; }
  .hero .alt small{ font-weight:600; opacity:.9; }

  /* Painéis */
  .panel{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin-top:10px; }
  .panel-h{ padding:10px 12px; font-weight:800; font-size:17px; background:#0b1628; border-bottom:1px solid var(--border); }
  .panel-b{ padding:10px 12px; }
  .legend{ font-size:12px; color:var(--muted); margin-bottom:6px; }

  /* Inputs */
  label{ font-size:13px; display:block; margin:10px 0 6px; }
  input[type="text"]{
    width:100%; padding:12px 14px; font-size:16px;
    border-radius:12px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; outline:none;
  }
  /* Estilo para inputs de porcentagem */
  .input-group { position: relative; }
  .input-group::after {
    content: '%';
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 16px;
    pointer-events: none; /* Não interfere com o input */
  }
  .input-group.custo::after { content: 'R$'; }
  .input-group input { padding-right: 30px; } /* Espaço para o % */
  .input-group.custo input { padding-right: 40px; } /* Espaço para o R$ */


  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (max-width:520px){ .grid{ grid-template-columns:1fr 1fr; } }
  @media (max-width:400px){ .grid{ grid-template-columns:1fr; } }

  .row-actions{ display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
  button{ padding:12px 16px; border-radius:12px; border:none; color:white; font-weight:800; cursor:pointer; transition: background-color 0.2s; }
  .btn-primary{ background:linear-gradient(135deg,var(--brand1),var(--brand2)); flex:1; min-width:140px; }
  .btn-secondary{ background:#0b1220; color:#e5e7eb; border:1px solid #334155; }
  .btn-primary:hover { opacity: 0.9; }
  .btn-secondary:hover { background: #1f2937; }

  .switch{ display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted); margin-top:2px; }

  /* Impacto */
  .impact .box{ border:1px solid #1f2a44; border-radius:16px; padding:12px; margin:10px 0; background:#0b1628; }
  .impact .lbl{ font-weight:800; letter-spacing:.3px; font-size:12px; color:#cbd5e1; margin-bottom:6px; text-transform:uppercase; }
  .impact .valor{ font-size:34px; font-weight:900; margin:0; line-height:1; }
  .impact .valor.green{ color:var(--success); }
  .impact .subtxt{ font-size:12px; color:#a1a1aa; margin-top:4px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; }
  .neg{ color:var(--danger); font-weight:700; }
  .pos{ color:var(--success); font-weight:700; } /* Adicionado para lucro positivo */


  /* KPIs finais */
  .summary .kpis{ display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:14px; }
  .kpi{ background:#0b1628; border:1px solid #1f2a44; border-radius:14px; padding:12px; min-height:96px; }
  .kpi .label{ font-size:13px; color:#cbd5e1; margin-bottom:6px; }
  .kpi .value{ font-size:22px; font-weight:900; margin:0; line-height:1; }
  .kpi .foot{ margin-top:6px; display:flex; align-items:center; gap:8px; }
  .kpi .pct{ font-size:12px; color:#22c55e; font-weight:700; }
  .kpi .ok{ width:16px; height:16px; flex:0 0 16px; display:inline-block; background:#22c55e; border-radius:50%; position:relative; }
  .kpi .ok::after{ content:""; position:absolute; left:4px; top:2px; width:6px; height:10px; border-right:2px solid #0b1628; border-bottom:2px solid #0b1628; transform:rotate(45deg); }
  .kpi .alert { background: var(--danger); } /* Estilo para alerta/negativo */
  .kpi .alert::after{ background: var(--danger); border-right:2px solid #0b1628; border-bottom:2px solid #0b1628; }

  footer{ text-align:center; font-size:12px; color:#94a3b8; margin:18px 0 8px; line-height:1.5; padding:0 8px; }
</style>

<script>
// Funções auxiliares
function $(id){ return document.getElementById(id); }

// Função de formatação de moeda (BRL)
function fmt(v){
  // Garante que v é um número finito, caso contrário retorna R$ 0,00
  if (!isFinite(v) || v === null) return 'R$ 0,00';
  
  // Arredonda para 2 casas decimais para evitar problemas de ponto flutuante
  const num = Math.round(v * 100) / 100;
  
  // Usa Intl.NumberFormat para formatação robusta
  return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

// Função de conversão de string para número (suporta formato brasileiro)
function toNum(s){
  if (s === null || s === undefined) return 0;
  
  // Remove espaços e substitui vírgula por ponto para o formato decimal
  let str = String(s).trim().replace(/\s/g, '');
  
  // Tenta detectar se é formato brasileiro (vírgula como separador decimal)
  // Exemplo: 1.000,50 -> 1000.50
  // Exemplo: 1000,50 -> 1000.50
  // Exemplo: 1000.50 -> 1000.50
  
  // Se houver vírgula, assume que é o separador decimal e remove pontos de milhar
  if (str.includes(',')) {
    str = str.replace(/\./g, '').replace(',', '.');
  }
  
  const n = parseFloat(str);
  return isNaN(n) ? 0 : n;
}

// Função para calcular o valor percentual
function val(preco, percentual){ 
  return preco * (percentual / 100); 
}

// Função principal de cálculo
function calcular(){
  // 1. Coleta e sanitização dos inputs
  const custo     = toNum($('custo').value);
  const despesas  = toNum($('despesas').value);
  const lucro     = toNum($('lucro').value); // Lucro desejado
  const impostos  = toNum($('aliquota').value);
  const comissao  = toNum($('comissao').value);
  const desconto  = toNum($('desconto').value);
  const preservar = $('preservar').checked;

  // 2. Validação da soma do Markup
  const somaMarkup = despesas + lucro + impostos + comissao;
  if(somaMarkup >= 100){ 
    alert('A soma de Despesas, Impostos, Lucro e Comissão não pode ser igual ou superior a 100%. Por favor, ajuste os valores.'); 
    // Limpa a exibição e retorna
    limparResultados();
    return; 
  }
  
  // 3. Cálculo do Markup e Preço Base
  const fatorMarkup = 100 / (100 - somaMarkup);
  const precoBase = custo * fatorMarkup;
  
  let precoCalc = precoBase; // Preço sem desconto
  let precoFinal;            // Preço com desconto

  // 4. Aplicação do Desconto
  if(preservar){
    // Opção "Preservar Margem": o desconto é aplicado sobre o Markup (fatorMarkup)
    // O preço final é o preço base (sem desconto)
    precoFinal = precoBase;
    
    // O preço calculado (que será exibido como "Preço Sugerido") é ajustado para absorver o desconto
    // PrecoCalc * (1 - desconto/100) = PrecoFinal
    const fatorDesconto = 1 - (desconto / 100);
    precoCalc = (fatorDesconto > 0) ? (precoFinal / fatorDesconto) : precoFinal;
    
    // NOTA: Na lógica original, o "precoSemDescBase" era o precoFinal. 
    // Mantenho a lógica de que precoFinal é o preço que o cliente paga, e precoCalc é o preço de tabela.
    // Se preservar, o precoFinal (o que o cliente paga) deve ser o Preço Base (sem desconto)
    // E o PrecoCalc (Preço Sugerido) deve ser o preço de tabela que, após o desconto, resulta no Preço Base.
    // A lógica original (linhas 107-110) estava um pouco confusa, mas o resultado final é o mesmo:
    // precoFinal = precoSemDescBase;
    // precoCalc = precoFinal / (1 - (desconto/100));
    // A única diferença é que, se preservar, o Preço Final (o que o cliente paga) é o Preço Base.
    // Vou manter a estrutura da lógica original, mas com nomes mais claros.
    
    // Revertendo para a lógica original para manter a compatibilidade, mas com nomes claros:
    // precoBase é o preço que garante a margem.
    // Se preservar, o Preço Final (o que o cliente paga) é o precoBase.
    // O Preço Sugerido (precoCalc) é o preço de tabela que, com o desconto, chega ao precoBase.
    precoFinal = precoBase;
    const fatorDescontoInv = 1 / (1 - (desconto / 100));
    precoCalc = (desconto > 0) ? (precoBase * fatorDescontoInv) : precoBase;
    
  } else {
    // Opção padrão: o desconto é aplicado sobre o preço calculado
    precoCalc = precoBase;
    precoFinal = precoCalc * (1 - desconto / 100);
  }
  
  // 5. Cálculo dos Componentes (sem desconto) - Base para KPIs
  // Usamos precoBase/precoCalc (o preço de tabela) para calcular os componentes percentuais
  const dBase      = val(precoCalc, despesas);
  const iBase      = val(precoCalc, impostos);
  const cBase      = val(precoCalc, comissao);
  const lBase      = val(precoCalc, lucro); // Lucro sobre venda (desejado)
  const lucroRealBase = precoCalc - custo - dBase - iBase - cBase; // Lucro residual (real)

  // 6. Cálculo dos Componentes Finais (com desconto)
  // Usamos precoFinal (o preço que o cliente paga)
  const dFinal = val(precoFinal, despesas);
  const iFinal = val(precoFinal, impostos);
  const cFinal = val(precoFinal, comissao);
  const lucroRealFinal = precoFinal - custo - dFinal - iFinal - cFinal; // Lucro residual (real)

  // 7. Resultados de Impacto
  const reducaoLucro = Math.max(0, lucroRealBase - lucroRealFinal);
  
  // 8. Atualização da Interface
  
  // HERO
  $('p-sug').textContent = fmt(precoCalc);
  const wrap = $('p-desc-wrap');
  if((desconto||0)>0){ 
    wrap.style.display='block'; 
    $('p-desc').textContent = fmt(precoFinal); 
  } else { 
    wrap.style.display='none'; 
  }
  
  // IMPACTO
  $('preco-sem').textContent   = fmt(precoCalc);
  $('preco-com').textContent   = fmt(precoFinal);
  
  // Lucro sobre venda
  $('lucro-sv-sem').textContent= fmt(lBase);
  $('lucro-sv-com').textContent= fmt(val(precoFinal, lucro)); // Lucro sobre venda (desejado) no preço final
  
  // Lucro Real (Residual)
  $('lucro-real-sem').textContent = fmt(lucroRealBase);
  $('lucro-real-com').textContent = fmt(lucroRealFinal);
  
  // Redução do Lucro
  $('lucro-reducao').textContent  = fmt(reducaoLucro);
  
  // 9. Atualização dos KPIs Finais (Análise do Preço Sugerido)
  const pc = precoCalc || 0.000001;
  
  // Valores (R$)
  $('sum-custo').textContent  = fmt(custo);
  $('sum-desp').textContent   = fmt(dBase);
  $('sum-imp').textContent    = fmt(iBase);
  $('sum-lucro').textContent  = fmt(lBase); // Lucro sobre venda (desejado)
  $('sum-comiss').textContent = fmt(cBase);
  const descVal = precoCalc * (desconto/100);
  $('sum-desc').textContent   = fmt(descVal);

  // Percentuais (%)
  const pctCusto  = (custo/pc)*100;
  const pctDesp   = (dBase/pc)*100;
  const pctImp    = (iBase/pc)*100;
  const pctLucro  = lucro; // É o percentual desejado
  const pctComiss = comissao;
  const pctDesc   = desconto;
  
  $('sum-custo-p').textContent  = pctCusto.toFixed(1)+'%';
  $('sum-desp-p').textContent   = pctDesp.toFixed(1)+'%';
  $('sum-imp-p').textContent    = pctImp.toFixed(1)+'%';
  $('sum-lucro-p').textContent  = pctLucro.toFixed(1)+'%';
  $('sum-comiss-p').textContent = pctComiss.toFixed(1)+'%';
  $('sum-desc-p').textContent   = pctDesc.toFixed(1)+'%';
  
  // Adiciona lógica de status para o KPI de Lucro Real
  const kpiLucroReal = $('kpi-lucro-real');
  const lucroRealPct = (lucroRealBase / pc) * 100;
  $('sum-lucro-real').textContent = fmt(lucroRealBase);
  $('sum-lucro-real-p').textContent = lucroRealPct.toFixed(1)+'%';
  
  const statusIcon = kpiLucroReal.querySelector('.status-icon');
  if (lucroRealBase > 0) {
    statusIcon.classList.remove('alert');
    statusIcon.classList.add('ok');
  } else {
    statusIcon.classList.remove('ok');
    statusIcon.classList.add('alert');
  }

  // Exibe o painel de resumo
  $('sum-panel').style.display = (precoCalc>0)?'block':'none';
}

// Limpa os campos de input
function limpar(){
  ['custo','despesas','lucro','aliquota','comissao','desconto'].forEach(id=>$(id).value='');
  $('preservar').checked=false;
  calcular();
}

// Limpa os resultados (usado em caso de erro)
function limparResultados() {
  // HERO
  $('p-sug').textContent = 'R$ 0,00';
  $('p-desc-wrap').style.display='none';
  
  // IMPACTO
  $('preco-sem').textContent   = 'R$ 0,00';
  $('preco-com').textContent   = 'R$ 0,00';
  $('lucro-sv-sem').textContent= 'R$ 0,00';
  $('lucro-sv-com').textContent= 'R$ 0,00';
  $('lucro-real-sem').textContent = 'R$ 0,00';
  $('lucro-real-com').textContent = 'R$ 0,00';
  $('lucro-reducao').textContent  = 'R$ 0,00';
  
  // KPIs
  $('sum-panel').style.display = 'none';
}

// Inicialização
document.addEventListener('DOMContentLoaded',()=>{
  // Adiciona event listeners para 'input' em todos os campos relevantes
  ['custo','despesas','lucro','aliquota','comissao','desconto'].forEach(id=>{
    const input = $(id);
    input.addEventListener('input', calcular);
    // Adiciona evento para formatar o valor ao perder o foco (melhor UX)
    input.addEventListener('blur', (e) => {
        const num = toNum(e.target.value);
        e.target.value = num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    });
    // Adiciona evento para remover a formatação ao ganhar o foco
    input.addEventListener('focus', (e) => {
        const num = toNum(e.target.value);
        e.target.value = num === 0 ? '' : num.toFixed(2).replace('.', ',');
    });
  });
  
  $('preservar').addEventListener('change',calcular);
  
  // Remove listeners dos botões 'calc' e 'clear' se o cálculo for automático
  // Se o cálculo for automático, os botões 'calc' e 'clear' não precisam de um listener 'click' para 'calcular'
  // Mas o botão 'clear' precisa do listener 'limpar'
  $('clear').addEventListener('click',limpar);
  
  // Executa o cálculo inicial para preencher os valores
  calcular();
});
</script>
</head>

<body>
  <div class="container">
    <!-- Título -->
    <h1 class="app-title">Preço Certo</h1>
    <p class="app-sub">Calculadora de Precificação Inteligente</p>

    <!-- Hero -->
    <div class="hero">
      <div class="title">Preço Sugerido (Preço de Tabela)</div>
      <div id="p-sug" class="price">R$ 0,00</div>
      <div id="p-desc-wrap" class="alt" style="display:none;"><small>Preço Final (c/ desconto):</small> <span id="p-desc">R$ 0,00</span></div>
      <div class="sub">Valor que garante sua margem de lucro.</div>
    </div>

    <!-- Form -->
    <div class="panel">
      <div class="panel-h">Parâmetros de Precificação</div>
      <div class="panel-b">
        <div class="legend">Preencha os campos abaixo. Percentuais são aplicados sobre o Preço de Venda.</div>
        <div class="grid">
          <div class="input-group custo"><label for="custo">Custo do Produto (R$)</label><input id="custo" type="text" inputmode="decimal" autocomplete="off" placeholder="0,00"/></div>
          <div class="input-group"><label for="despesas">Despesas Fixas e Variáveis (%)</label><input id="despesas" type="text" inputmode="decimal" autocomplete="off" placeholder="0,00"/></div>
          <div class="input-group"><label for="lucro">Lucro Desejado (%)</label><input id="lucro" type="text" inputmode="decimal" autocomplete="off" placeholder="0,00"/></div>
          <div class="input-group"><label for="aliquota">Impostos/Taxas (%)</label><input id="aliquota" type="text" inputmode="decimal" autocomplete="off" placeholder="0,00"/></div>
          <div class="input-group"><label for="comissao">Comissão de Venda (%)</label><input id="comissao" type="text" inputmode="decimal" autocomplete="off" placeholder="0,00"/></div>
          <div class="input-group"><label for="desconto">Desconto Aplicado (%)</label><input id="desconto" type="text" inputmode="decimal" autocomplete="off" placeholder="0,00"/></div>
        </div>

        <div class="row-actions">
          <div class="switch">
            <input id="preservar" type="checkbox"/>
            <label for="preservar">Preservar margem (desconto absorvido no preço de tabela)</label>
          </div>
          <button id="calc" type="button" class="btn-primary">Recalcular</button>
          <button id="clear" type="button" class="btn-secondary">Limpar Tudo</button>
        </div>
      </div>
    </div>

    <!-- Impacto do Desconto -->
    <div class="panel impact">
      <div class="panel-h">Análise de Margem e Lucro</div>
      <div class="panel-b">
        <div class="box">
          <div class="lbl">PREÇO DE TABELA (Sugerido)</div>
          <div class="valor mono" id="preco-sem">R$ 0,00</div>
          <div class="subtxt">Preço sem considerar o desconto no cálculo.</div>
        </div>
        <div class="box">
          <div class="lbl">PREÇO FINAL (Pago pelo Cliente)</div>
          <div class="valor mono green" id="preco-com">R$ 0,00</div>
          <div class="subtxt">Valor final após a aplicação do desconto.</div>
        </div>
        <div class="box">
          <div class="lbl">Lucro Desejado (Sobre Venda)</div>
          <div class="subtxt">No Preço de Tabela: <span class="mono pos" id="lucro-sv-sem">R$ 0,00</span></div>
          <div class="subtxt">No Preço Final: <span class="mono" id="lucro-sv-com">R$ 0,00</span></div>
        </div>
        <div class="box">
          <div class="lbl">Lucro Real (Residual)</div>
          <div class="subtxt">No Preço de Tabela: <span class="mono pos" id="lucro-real-sem">R$ 0,00</span></div>
          <div class="subtxt">No Preço Final: <span class="mono" id="lucro-real-com">R$ 0,00</span></div>
          <div class="subtxt">Redução do Lucro Real devido ao desconto: <span class="mono neg" id="lucro-reducao">R$ 0,00</span></div>
        </div>
      </div>
    </div>

    <!-- KPIs finais -->
    <div class="panel summary" id="sum-panel" style="display:none;">
      <div class="panel-h">Composição do Preço de Tabela (R$ <span id="p-sug-kpi">0,00</span>)</div>
      <div class="panel-b">
        <div class="kpis">
          <div class="kpi"><div class="label">Custo do Produto</div><div class="value mono" id="sum-custo">R$ 0,00</div><div class="foot"><span class="pct" id="sum-custo-p">0%</span><span class="ok status-icon"></span></div></div>
          <div class="kpi"><div class="label">Despesas</div><div class="value mono" id="sum-desp">R$ 0,00</div><div class="foot"><span class="pct" id="sum-desp-p">0%</span><span class="ok status-icon"></span></div></div>
          <div class="kpi"><div class="label">Impostos</div><div class="value mono" id="sum-imp">R$ 0,00</div><div class="foot"><span class="pct" id="sum-imp-p">0%</span><span class="ok status-icon"></span></div></div>
          <div class="kpi" id="kpi-lucro-real"><div class="label">Lucro Real (Residual)</div><div class="value mono" id="sum-lucro-real">R$ 0,00</div><div class="foot"><span class="pct" id="sum-lucro-real-p">0%</span><span class="ok status-icon"></span></div></div>
          <div class="kpi"><div class="label">Comissão</div><div class="value mono" id="sum-comiss">R$ 0,00</div><div class="foot"><span class="pct" id="sum-comiss-p">0%</span><span class="ok status-icon"></span></div></div>
          <div class="kpi"><div class="label">Desconto Aplicado</div><div class="value mono" id="sum-desc">R$ 0,00</div><div class="foot"><span class="pct" id="sum-desc-p">0%</span><span class="ok status-icon"></span></div></div>
        </div>
      </div>
    </div>

    <footer>
      <strong>Desenvolvida por Eduardo Pires</strong> — Analista de Dados<br/>
      Todos os direitos reservados à <strong>E-Tech Sistemas</strong> · 📞 (75) 99955-3626<br/>
      <span style="font-size:11px;">Cópia, reprodução ou redistribuição não autorizada é expressamente proibida.</span>
    </footer>
  </div>
</body>
</html>
